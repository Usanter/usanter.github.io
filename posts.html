<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Blog — Thomas Rolland</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..800&display=swap" rel="stylesheet">
    <style>
      :root { --bg:#f6f7f9; --surface: rgba(255,255,255,0.25); --text:#0e1116; --muted:#5a6472; --outline: rgba(255,255,255,0.4); --radius: clamp(16px, 2.2vw, 24px); --shadow: 0 1px 1px rgba(0,0,0,.05), 0 10px 30px rgba(12,20,33,.12);} 
      body{ margin:0; font-family:'Inter',system-ui,-apple-system; background:var(--bg); color:var(--text);} 
      .backdrop { position: fixed; inset: -20% -10% auto -10%; height: 60vh; z-index: -2; background: radial-gradient(42% 60% at 20% 30%, hsla(218,86%,55%,.18), transparent 55%), radial-gradient(40% 55% at 78% 25%, hsla(266,85%,62%,.16), transparent 60%), radial-gradient(70% 70% at 50% 90%, hsla(194,86%,54%,.14), transparent 60%); filter: blur(40px) saturate(120%); animation: floatY 18s ease-in-out infinite alternate; }
      @keyframes floatY { from { transform: translateY(-2%);} to { transform: translateY(4%);} }
      #liquid-bg { position: fixed; inset: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; display: block; }
      .container{ max-width:1040px; margin:0 auto; padding:32px 20px 64px;}
      header.site-header{ position:sticky; top:0; z-index:1000; display:flex; align-items:center; justify-content:space-between; gap:16px; padding:10px 14px; background:var(--surface); border:1px solid var(--outline); backdrop-filter: blur(16px) saturate(140%); -webkit-backdrop-filter: blur(16px) saturate(140%); box-shadow: 0 8px 24px rgba(0,0,0,.12); border-radius:0 0 var(--radius) var(--radius);} 
      .brand{ font-weight:700; letter-spacing:-0.02em; font-size:clamp(18px,1.4vw,22px); text-decoration:none; color:inherit; }
      nav a{ color:var(--muted); text-decoration:none; margin-left:12px; font-size:14px; padding:8px 10px; border-radius:12px; }
      nav a:hover{ background:rgba(255,255,255,.5); color:var(--text);} 
      .card{ background: var(--surface); border:1px solid var(--outline); border-radius:var(--radius); box-shadow:0 8px 24px rgba(0,0,0,.12); backdrop-filter: blur(16px) saturate(140%);} 
      .section-title{ display:flex; align-items:center; justify-content:space-between; margin:16px 0 14px; }
      .section-title h1{ margin:0; font-size:clamp(22px,3vw,28px);} .section-title p{ margin:0; color:var(--muted); font-size:14px;}
      .grid-3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:clamp(12px,2.2vw,20px);} @media(max-width:860px){ .grid-3{ grid-template-columns: 1fr; }}
      .project.card{ padding:18px; }
      .topline{ display:flex; justify-content:space-between; gap:8px; align-items:center; margin-bottom:8px;}
      .pill{ display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--outline); background:rgba(255,255,255,.5); font-size:12px; color:var(--muted);} 
      .tag{ display:inline-block; font-size:12px; color:var(--muted); background:rgba(255,255,255,.6); border:1px solid var(--outline); padding:4px 8px; border-radius:999px; margin-right:6px; }
      .btn{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--outline); background:rgba(255,255,255,.5); padding:10px 14px; border-radius:12px; color:var(--text); text-decoration:none; font-weight:600; }
      .btn:hover{ transform:translateY(-1px);} 
      .actions{ display:flex; gap:8px; margin-top:10px; }
      .post.card{ padding: clamp(20px, 3.6vw, 30px); margin-top:16px; }
      .prose p{ line-height:1.6; color:var(--muted);} .prose pre{ overflow:auto; padding:12px; background:rgba(0,0,0,.06); border-radius:12px; }
      footer{ text-align:center; color:var(--muted); padding:20px 0; }
    </style>
  </head>
  <body>
    <div class="backdrop" aria-hidden="true"></div>
    <canvas id="liquid-bg" aria-hidden="true"></canvas>
    <div class="container">
      <header class="site-header">
        <a class="brand" href="index.html">Thomas Rolland</a>
        <nav aria-label="Primary">
          <a href="index.html#about">About</a>
          <a href="publications.html">Publications</a>
          <a href="activities.html">Activities</a>
          <a href="teaching.html">Teaching</a>
          <a href="posts.html">Blog</a>
          <a href="index.html#contact">Contact</a>
        </nav>
      </header>

      <section id="list">
        <div class="section-title">
          <h1>All Blog Posts</h1>
          <p>Explainers & deep dives</p>
        </div>
        <div id="blog-list" class="grid-3"></div>
      </section>

      <article id="post-view" class="post card" hidden>
        <div class="topline"><span class="pill" id="post-date"></span><span class="pill">Blog</span></div>
        <h2 class="post-title" id="post-title"></h2>
        <div class="tags" id="post-tags"></div>
        <div class="prose" id="post-content"></div>
        <div class="actions">
          <button class="btn" id="post-back" type="button">← Back to list</button>
          <a class="btn" id="post-raw" href="#" target="_blank" rel="noopener">Open raw (.md)</a>
        </div>
      </article>

      <footer>
        <small>© <span id="year"></span> Thomas Rolland</small>
      </footer>
    </div>

    <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

    <!-- Three.js pastel liquid background (same as homepage) -->
    <script type="module">
      import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
      const CONFIG = { colors:['#FFFFFF','#FEFCFB','#F0F4FF','#F3E8FF','#FEF9F6'], speed:0.08, blur:2.6, grain:0.008, dprMax: 2.0 };
      const canvas = document.getElementById('liquid-bg');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, powerPreference: 'high-performance' });
      const DPR = Math.min(window.devicePixelRatio || 1, CONFIG.dprMax);
      renderer.setPixelRatio(DPR); renderer.setClearColor(0xffffff, 1);
      const scene = new THREE.Scene();
      const camera = new THREE.OrthographicCamera(-1,1,1,-1,0,1);
      const vertexShader = `varying vec2 vUv; void main(){ vUv = uv; gl_Position = vec4(position, 1.0); }`;
      const fragmentShader = `
        precision highp float; uniform float uTime; uniform vec2 uResolution; uniform vec3 uColors[5]; uniform float uBlur; uniform float uGrain; uniform float uSpeed;
        float hash(vec2 p){ return fract(sin(dot(p, vec2(127.1,311.7)))*43758.5453123);} 
        float noise(vec2 p){ vec2 i=floor(p), f=fract(p); float a=hash(i), b=hash(i+vec2(1.,0.)), c=hash(i+vec2(0.,1.)), d=hash(i+vec2(1.,1.)); vec2 u=f*f*(3.-2.*f); return mix(a,b,u.x)+(c-a)*u.y*(1.-u.x)+(d-b)*u.x*u.y; }
        float fbm(vec2 p){ float v=0., a=.5; for(int i=0;i<5;i++){ v+=a*noise(p); p=p*2.+vec2(10.5); a*=.5;} return v; }
        float metaball(vec2 p, vec2 c, float r){ float d=length(p-c); return r*r/(d*d+1e-3);} 
        vec3 multiMix(float t, vec3[5] cols){ if(t<.25) return mix(cols[0],cols[1],smoothstep(0.,.25,t)); else if(t<.5) return mix(cols[1],cols[2],smoothstep(.25,.5,t)); else if(t<.75) return mix(cols[2],cols[3],smoothstep(.5,.75,t)); else return mix(cols[3],cols[4],smoothstep(.75,1.,t)); }
        void main(){ vec2 uv = gl_FragCoord.xy / uResolution; vec2 p = (uv - 0.5) * 2.0; p.x *= uResolution.x / uResolution.y; float t = uTime * uSpeed;
          vec2 warp = vec2(fbm(p*1.2 + t*.30), fbm(vec2(p.y,p.x)*1.5 - t*.25)); p += .25 * (warp - .5);
          vec2 c1=.70*vec2(sin(t*.70+0.), cos(t*.60+1.2)); vec2 c2=.80*vec2(cos(t*.55+2.2), sin(t*.50+.3)); vec2 c3=.90*vec2(sin(t*.40+4.), sin(t*.65+2.)); vec2 c4=.60*vec2(cos(t*.33-1.), cos(t*.47-2.4)); vec2 c5=.75*vec2(sin(t*.29-.5), cos(t*.41+.7));
          float field=0.; field+=metaball(p,c1,.65); field+=metaball(p,c2,.70); field+=metaball(p,c3,.60); field+=metaball(p,c4,.68); field+=metaball(p,c5,.62); field*=.22;
          float m=smoothstep(.35,.75,field); float r=uBlur/uResolution.y; vec2 off[8]; off[0]=vec2( r,0.); off[1]=vec2(-r,0.); off[2]=vec2(0., r); off[3]=vec2(0.,-r); off[4]=vec2( r, r); off[5]=vec2(-r, r); off[6]=vec2( r,-r); off[7]=vec2(-r,-r);
          float accum=m; for(int i=0;i<8;i++){ vec2 pp=p+off[i]; float f2=0.; f2+=metaball(pp,c1,.65); f2+=metaball(pp,c2,.70); f2+=metaball(pp,c3,.60); f2+=metaball(pp,c4,.68); f2+=metaball(pp,c5,.62); f2*=.22; accum+=smoothstep(.35,.75,f2); }
          float blurred=accum/9.; float n=fbm(p*1.8 + t*.15); float mixv=clamp(blurred + (n-.5)*.25, 0., 1.); vec3 col=multiMix(mixv, uColors); float vignette=smoothstep(1.4,.2,length(p)); col*=mix(.99,1.03,vignette); float g=(hash(uv+fract(t))-.5)*uGrain; col+=g; gl_FragColor=vec4(col,1.);
        }`;
      const material = new THREE.ShaderMaterial({
        uniforms: { uTime:{value:0}, uResolution:{value:new THREE.Vector2(1,1)}, uColors:{ value: CONFIG.colors.map(c=>new THREE.Color(c)) }, uBlur:{value:CONFIG.blur}, uGrain:{value:CONFIG.grain}, uSpeed:{value:CONFIG.speed} },
        vertexShader, fragmentShader, depthTest:false, depthWrite:false,
      });
      const quad = new THREE.Mesh(new THREE.PlaneGeometry(2,2), material); scene.add(quad);
      function resize(){ const w=innerWidth,h=innerHeight; renderer.setSize(w,h,false); material.uniforms.uResolution.value.set(w*DPR,h*DPR); }
      addEventListener('resize', resize, {passive:true}); resize();
      const media = matchMedia('(prefers-reduced-motion: reduce)'); function updateSpeed(){ material.uniforms.uSpeed.value = media.matches ? CONFIG.speed*0.08 : CONFIG.speed; } media.addEventListener?.('change', updateSpeed); updateSpeed();
      const clock = new THREE.Clock(); (function loop(){ material.uniforms.uTime.value=clock.getElapsedTime(); renderer.render(scene,camera); requestAnimationFrame(loop); })();
      document.addEventListener('visibilitychange', ()=>{ /* stop/start if needed */ });
    </script>

    <!-- Blog loader: read posts.json and markdown -->
    <script>
      (async function(){
        const listEl = document.getElementById('blog-list');
        const viewEl = document.getElementById('post-view');
        const titleEl = document.getElementById('post-title');
        const dateEl = document.getElementById('post-date');
        const tagsEl = document.getElementById('post-tags');
        const contentEl = document.getElementById('post-content');
        const backBtn = document.getElementById('post-back');
        const rawLink = document.getElementById('post-raw');

        function escapeHtml(s){ return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
        function parseFrontmatter(text){
          let meta = {}; let body = text;
          if (text.startsWith('---')){
            const end = text.indexOf('\n---', 3);
            if (end !== -1){
              const block = text.slice(3, end).trim();
              body = text.slice(end + 4).trim();
              for (const line of block.split('\n')){
                const idx = line.indexOf(':'); if (idx > -1){ const k=line.slice(0,idx).trim(); const v=line.slice(idx+1).trim(); meta[k]=v.replace(/^\"|\"$/g,''); }
              }
            }
          }
          if (!meta.title){ const m = body.match(/^#\s+(.+)$/m); if (m) meta.title = m[1].trim(); }
          if (!meta.summary){ const paras = body.split(/\n\s*\n/).map(s => s.trim()).filter(Boolean); const firstPara = paras.find(p => !p.startsWith('#')); if (firstPara) meta.summary = firstPara.replace(/^>\s*/,''); }
          return { meta, body };
        }
        function mdToHtml(md){
          const fenceRegex = /```([\w-]*)\n([\s\S]*?)```/g; const fences = [];
          md = md.replace(fenceRegex, (_, lang, code) => { const i = fences.push({ lang, code }) - 1; return `§§FENCE${i}§§`; });
          const lines = md.split(/\r?\n/); const out = []; let inOl=false, inUl=false; const close=()=>{ if(inOl){out.push('</ol>'); inOl=false;} if(inUl){out.push('</ul>'); inUl=false;} };
          for (let raw of lines){ let line = raw.trimEnd(); if (!line){ close(); out.push(''); continue; }
            const h=line.match(/^(#{1,6})\s+(.*)$/); if (h){ close(); const lvl=h[1].length; out.push(`<h${lvl}>${escapeHtml(h[2])}</h${lvl}>`); continue; }
            const ol=line.match(/^\d+\.\s+(.*)$/); if (ol){ if(!inOl){ close(); out.push('<ol>'); inOl=true; } out.push(`<li>${escapeHtml(ol[1])}</li>`); continue; }
            const ul=line.match(/^[-*]\s+(.*)$/); if (ul){ if(!inUl){ close(); out.push('<ul>'); inUl=true; } out.push(`<li>${escapeHtml(ul[1])}</li>`); continue; }
            const bq=line.match(/^>\s?(.*)$/); if (bq){ close(); out.push(`<blockquote><p>${escapeHtml(bq[1])}</p></blockquote>`); continue; }
            close(); out.push(`<p>${escapeHtml(line)}</p>`); }
          let html=out.join('\n');
          html=html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
                   .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g,'<em>$1</em>')
                   .replace(/`([^`]+)`/g,'<code>$1</code>')
                   .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
          html=html.replace(/§§FENCE(\d+)§§/g,(_,i)=>{ const f=fences[Number(i)]; return `<pre><code class="language-${escapeHtml(f.lang||'')}">${escapeHtml(f.code)}</code></pre>`; });
          return html;
        }

        // Build list from manifest
        let posts = [];
        try {
          const res = await fetch('posts/posts.json', { cache: 'no-store' });
          if (res.ok) posts = await res.json();
        } catch (_) {}

        for (const p of posts){
          const article = document.createElement('article');
          article.className = 'project card';
          const tags = Array.isArray(p.tags)? p.tags : String(p.tags||'').split(',');
          const tagsHtml = tags.map(t => String(t).trim()).filter(Boolean).map(t => `<span class="tag">${t}</span>`).join('');
          article.innerHTML = `
            <div class="topline"><span class="pill">${p.date || ''}</span><span class="pill">Blog</span></div>
            <h3>${p.title || p.path}</h3>
            ${p.summary ? `<p>${p.summary}</p>` : ''}
            ${tagsHtml ? `<div class="tags">${tagsHtml}</div>` : ''}
            <div class="actions"><button class="btn read-post" data-path="${p.path}">Read</button><a class="btn" href="${p.path}" target="_blank" rel="noopener">Raw (.md)</a></div>
          `;
          listEl.appendChild(article);
        }

        async function showPost(path){
          try{
            const res = await fetch(path); if (!res.ok) throw new Error('HTTP '+res.status);
            const text = await res.text();
            const { meta, body } = parseFrontmatter(text);
            titleEl.textContent = meta.title || path; dateEl.textContent = meta.date || '';
            tagsEl.innerHTML = (meta.tags||'').split(',').map(t => t.trim()).filter(Boolean).map(t => `<span class="tag">${t}</span>`).join('');
            contentEl.innerHTML = mdToHtml(body); rawLink.href = path;
            listEl.hidden = true; viewEl.hidden = false;
            if (!location.hash.startsWith('#post=')) history.pushState({ post: path }, '', `#post=${encodeURIComponent(path)}`);
            viewEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
          } catch(err){ window.open(path, '_blank'); }
        }
        function hidePost(){ viewEl.hidden = true; listEl.hidden = false; }
        listEl.addEventListener('click', (e) => { const btn = e.target.closest('.read-post'); if (btn){ e.preventDefault(); showPost(btn.dataset.path); } }, true);
        backBtn?.addEventListener('click', () => { hidePost(); history.pushState({}, '', '#list'); });
        addEventListener('hashchange', () => { const m = location.hash.match(/#post=([^&]+)/); if (m) showPost(decodeURIComponent(m[1])); else hidePost(); });
        const m = location.hash.match(/#post=([^&]+)/); if (m) showPost(decodeURIComponent(m[1]));
      })();
    </script>
  </body>
</html>
